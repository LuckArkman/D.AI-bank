@page "/profile"
@attribute [Authorize]
@inject BankingService BankingService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthService AuthService

<div class="dashboard-header mb-4">
    <h1 class="fw-bold h2">Bem-vindo, @userName!</h1>
    <p class="text-muted">Aqui está o resumo da sua vida financeira.</p>
</div>

@if (accountNotFound)
{
    <div class="alert alert-warning border-0 rounded-4 shadow-sm mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <h6 class="fw-bold mb-1">Ops! Conta não localizada.</h6>
                <p class="small mb-0">Não conseguimos encontrar os dados bancários associados ao seu usuário. Isso pode
                    ocorrer se sua conta foi criada em outro ambiente ou tenant. Por favor, tente criar uma nova conta.</p>
                @if (!string.IsNullOrEmpty(debugInfo))
                {
                    <hr class="my-2 opacity-10">
                    <div class="x-small font-monospace opacity-50" style="font-size: 0.70rem;">
                        <p class="mb-1"><strong>ERRO API:</strong> @debugInfo</p>
                        <p class="mb-0"><strong>TOKEN CLAIMS:</strong> @tokenClaims</p>
                    </div>
                }
            </div>
        </div>
    </div>
}

<div class="row g-4">
    <!-- Balance Card -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 bg-primary text-white h-100">
            <div class="card-body p-4 d-flex flex-column justify-content-between">
                <div>
                    <h6 class="text-uppercase opacity-75 small fw-bold mb-3">Saldo Disponível</h6>
                    @if (isLoading)
                    {
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    }
                    else
                    {
                        <h2 class="display-5 fw-bold mb-0">R$ @balance.ToString("N2")</h2>
                    }
                </div>
                <div class="mt-4">
                    <button class="btn btn-light btn-sm rounded-pill px-3 shadow-none">Ver detalhes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Limits Card -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Limites de Conta</h6>
                <div class="d-flex align-items-center mb-2">
                    <div class="progress flex-grow-1" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 45%" aria-valuenow="45"
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="ms-3 fw-bold small">45%</span>
                </div>
                <p class="small text-muted mb-0">R$ 4.500,00 usados de R$ 10.000,00</p>
                <div class="mt-4">
                    <a href="/limits" class="btn btn-outline-primary btn-sm rounded-pill px-3">Gerenciar</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards Info Card -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Cartões Ativos</h6>
                <div class="d-flex align-items-center gap-2 mb-3">
                    <div class="bg-primary bg-opacity-10 p-2 rounded text-primary">
                        <i class="bi bi-credit-card-2-front-fill fs-4"></i>
                    </div>
                    <div>
                        <p class="mb-0 fw-bold">Virtual • 4829</p>
                        <p class="small text-muted mb-0">Mastercard</p>
                    </div>
                </div>
                <div class="mt-auto">
                    <a href="/cards" class="btn btn-outline-primary btn-sm rounded-pill px-3">Ver todos</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Transactions -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white border-0 p-4 pb-0">
                <h5 class="fw-bold mb-0">Últimas Movimentações</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light border-0">
                            <tr>
                                <th class="ps-4 border-0 small text-uppercase text-muted">Data</th>
                                <th class="border-0 small text-uppercase text-muted">Tipo</th>
                                <th class="border-0 small text-uppercase text-muted text-end pe-4">Valor</th>
                            </tr>
                        </thead>
                        <tbody class="border-top-0">
                            @if (statement == null)
                            {
                                <tr>
                                    <td colspan="3" class="text-center py-4">Carregando...</td>
                                </tr>
                            }
                            else if (!statement.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center py-4">Nenhuma transação.</td>
                                </tr>
                            }
                            else
                            {
                                foreach (var item in statement.Take(5))
                                {
                                    <tr>
                                        <td class="ps-4 align-middle small">@item.Timestamp.ToLocalTime().ToString("dd/MM                                    HH:mm")</td>
                                        <td class="align-middle">
                                            <span
                                                class="badge @(item.Type.Contains("CREDIT") ? "bg-success" : "bg-danger") bg-opacity-10 text-@(item.Type.Contains("CREDIT") ? "success" : "danger") rounded-pill">
                                                @item.Type
                                            </span>
                                        </td>
                                        <td class="text-end pe-4 align-middle fw-bold">
                                            R$ @item.Amount.ToString("N2")
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Personal Info -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white border-0 p-4 pb-0">
                <h5 class="fw-bold mb-0">Meus Dados</h5>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <img src="https://ui-avatars.com/api/?name=@userName&background=0d6efd&color=fff&size=80"
                        class="rounded-circle shadow-sm mb-3">
                    <h6 class="fw-bold mb-1">@userName</h6>
                    <p class="small text-muted mb-1">@userEmail</p>
                    <code class="x-small text-muted" style="font-size: 0.65rem;">ID: @currentAccountId</code>
                </div>
                <hr>
                <div class="mb-3">
                    <label class="small text-muted text-uppercase fw-bold d-block mb-1">Status da Conta</label>
                    <span class="badge bg-success bg-opacity-10 text-success px-3">Verificada</span>
                </div>
                <div class="mb-3">
                    <label class="small text-muted text-uppercase fw-bold d-block mb-1">Jurisdição Operacional</label>
                    <p class="mb-0 fw-medium">Brasil (BRL)</p>
                </div>
                <button class="btn btn-outline-secondary btn-sm w-100 rounded-pill mt-3" @onclick="Logout">Sair da
                    Conta</button>
            </div>
        </div>
    </div>
</div>

@code {
    private string userName = "Usuário";
    private string userEmail = "email@exemplo.com";
    private decimal balance = 0;
    private List<Fintech.Web.Services.StatementItem>? statement;
    private bool isLoading = true;
    private bool accountNotFound = false;
    private string? debugInfo;
    private string? tokenClaims;
    private string? currentAccountId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();

        // No JWT, os nomes costumam ser 'unique_name' ou 'name' e 'email'
        userName = authState.User.Claims.FirstOrDefault(c => c.Type == "unique_name")?.Value ??
        authState.User.Identity?.Name ?? "Usuário";

        userEmail = authState.User.Claims.FirstOrDefault(c => c.Type == "email")?.Value ??
        "email@exemplo.com";

        // Coleta claims para diagnóstico
        tokenClaims = string.Join(" | ", authState.User.Claims.Select(c => $"{c.Type.Split('/').Last()}:{c.Value}"));

        var accountIdClaim = authState.User.Claims.FirstOrDefault(c => c.Type == "AccountId")?.Value;
        currentAccountId = accountIdClaim;

        try
        {
            if (Guid.TryParse(accountIdClaim, out var accountId))
            {
                var balanceResponse = await BankingService.GetBalanceAsync(accountId);
                if (balanceResponse != null && string.IsNullOrEmpty(balanceResponse.Debug))
                {
                    balance = balanceResponse.AvailableBalance;
                    accountNotFound = false;
                }
                else
                {
                    accountNotFound = true;
                    debugInfo = balanceResponse?.Debug;
                }

                statement = await BankingService.GetStatementAsync(accountId);
            }
            else
            {
                accountNotFound = true;
                debugInfo = "AccountId não encontrado no Token.";
            }
        }
        catch (Exception ex)
        {
            accountNotFound = true;
            debugInfo = "Erro frontend: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
    }
}