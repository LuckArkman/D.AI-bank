@page "/operations"
@attribute [Authorize]
@inject BankingService BankingService
@inject IJSRuntime JS

<div class="dashboard-header mb-4">
    <h1 class="fw-bold h2">Operações</h1>
    <p class="text-muted">Realize transferências, PIX e depósitos.</p>
</div>

<div class="row g-4">
    <!-- PIX Transfer -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-4 text-primary">
                    <i class="bi bi-lightning-charge-fill fs-3 me-3"></i>
                    <h5 class="fw-bold mb-0">Enviar PIX</h5>
                </div>

                @if (!string.IsNullOrEmpty(pixMessage))
                {
                    <div class="alert @(pixSuccess ? "alert-success" : "alert-danger") border-0 rounded-4 small py-2">
                        @pixMessage
                    </div>
                }

                <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">Chave do Destinatário</label>
                    <input type="text" class="form-control bg-light border-0" placeholder="E-mail, CPF ou Telefone"
                        @bind="pixKey">
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold text-uppercase">Valor</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0">R$</span>
                        <input type="number" class="form-control bg-light border-0" @bind="pixAmount">
                    </div>
                </div>
                <button class="btn btn-primary w-100 py-3 shadow rounded-4" disabled="@isPixProcessing"
                    @onclick="HandlePix">
                    @if (isPixProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Confirmar Envio
                </button>
            </div>
        </div>
    </div>

    <!-- P2P Transfer -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100 text-dark">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-4 text-primary">
                    <i class="bi bi-arrow-repeat fs-3 me-3"></i>
                    <h5 class="fw-bold mb-0">Transferência Interna</h5>
                </div>

                @if (!string.IsNullOrEmpty(p2pMessage))
                {
                    <div class="alert @(p2pSuccess ? "alert-success" : "alert-danger") border-0 rounded-4 small py-2">
                        @p2pMessage
                    </div>
                }

                <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">ID da Conta Destino</label>
                    <input type="text" class="form-control bg-light border-0" placeholder="GUID da conta"
                        @bind="targetAccountId">
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold text-uppercase">Valor</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0">R$</span>
                        <input type="number" class="form-control bg-light border-0" @bind="p2pAmount">
                    </div>
                </div>
                <button class="btn btn-outline-primary w-100 py-3 rounded-4" disabled="@isP2PProcessing"
                    @onclick="HandleP2P">
                    @if (isP2PProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Transferir
                </button>
            </div>
        </div>
    </div>

    <!-- Deposit Simulation -->
    <div class="col-12 mt-4">
        <div class="card border-0 shadow-sm rounded-4 bg-dark text-white overflow-hidden">
            <div class="card-body p-4 p-lg-5">
                <div class="row align-items-center">
                    <div class="col-lg-7">
                        <h3 class="fw-bold mb-3">Simulação de Depósito</h3>
                        <p class="opacity-75 mb-4">Adicione fundos à sua conta instantaneamente para testes.</p>

                        <div class="d-flex gap-3">
                            <div class="input-group w-50">
                                <span class="input-group-text bg-transparent border-secondary text-white">R$</span>
                                <input type="number"
                                    class="form-control bg-transparent border-secondary text-white shadow-none"
                                    @bind="depositAmount">
                            </div>
                            <button class="btn btn-primary px-4 rounded-4" disabled="@isDepositProcessing"
                                @onclick="HandleDeposit">
                                @if (isDepositProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Creditar Conta
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-5 text-end d-none d-lg-block">
                        <i class="bi bi-wallet2 display-1 opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string pixKey = "";
    private decimal pixAmount = 0;
    private bool isPixProcessing = false;
    private string? pixMessage;
    private bool pixSuccess;

    private string targetAccountId = "";
    private decimal p2pAmount = 0;
    private bool isP2PProcessing = false;
    private string? p2pMessage;
    private bool p2pSuccess;

    private decimal depositAmount = 1000;
    private bool isDepositProcessing = false;

    private async Task HandlePix()
    {
        if (pixAmount <= 0) return;
        isPixProcessing = true;
        pixMessage = null;

        var result = await BankingService.SendPixAsync(pixKey, pixAmount);
        pixSuccess = result;
        pixMessage = result ? "PIX enviado com sucesso e está em processamento." : "Falha ao enviar PIX.";

        isPixProcessing = false;
    }

    private async Task HandleP2P()
    {
        if (p2pAmount <= 0 || !Guid.TryParse(targetAccountId, out var id)) return;
        isP2PProcessing = true;
        p2pMessage = null;

        var result = await BankingService.TransferP2PAsync(id, p2pAmount);
        p2pSuccess = result;
        p2pMessage = result ? "Transferência realizada com sucesso." : "Falha na transferência.";

        isP2PProcessing = false;
    }

    private async Task HandleDeposit()
    {
        if (depositAmount <= 0) return;
        isDepositProcessing = true;

        var result = await BankingService.DepositAsync(depositAmount);
        if (result)
        {
            await JS.InvokeVoidAsync("alert", "Depósito simulado com sucesso! Atualize o dashboard para ver o saldo.");
        }

        isDepositProcessing = false;
    }
}